{{!-- account-custom.hbs --}}
{{!-- This will be injected into your layout (head + nav + footer) via {{{body}}} --}}

<div class="home-wrapper">

  <div class="profile-card">

    <header class="profile-card-header">
      <h1 class="home-title">Your Tinderfy Profile</h1>
      <p class="home-lead">Edit your Tinderfy profile details. Your music taste is the key!</p>
    </header>

    <div id="statusMessage" style="display: none; padding: 12px; margin-bottom: 16px; border-radius: 8px; text-align: center; font-weight: 500;"></div>

    <form id="profileForm" class="profile-form">

      <!-- Userâ€‘ID / Info (if needed) -->
      <div class="form-group">
        <label>User ID (for reference)</label>
        <div id="userIdDisplay" class="form-value">{{#if user}}{{user.id}}{{else}}Loading...{{/if}}</div>
      </div>

      <!-- Profile Photo & Basic Info -->
      <div class="form-section flex-column flex-md-row gap-4">

        <div class="profile-photo-placeholder">
          <!-- (You can replace this with actual image preview) -->
          <div class="avatar-placeholder">ðŸ“·</div>
          <p class="small-text">Photo URL (Simulated)</p>
        </div>

        <div class="form-fields">

          <div class="form-group">
            <label for="name">Full Name</label>
            <input type="text" id="name" class="input-field" placeholder="Alex Johnson" value="{{#if user}}{{user.name}}{{/if}}" required>
          </div>

          <div class="form-group split-two">
            <div>
              <label for="username">Username</label>
              <input type="text" id="username" class="input-field" placeholder="VibeMaster" value="{{#if user}}{{user.username}}{{/if}}" required>
            </div>
            <div>
              <label for="dob">Date of Birth</label>
              <input type="date" id="dob" class="input-field" required>
            </div>
          </div>

        </div>

      </div>

      <!-- Bio and Location -->
      <div class="form-section">
        <div class="form-group">
          <label for="bio">About Me / Bio (Max 200 chars)</label>
          <textarea id="bio" rows="3" maxlength="200" class="textarea-field"></textarea>
        </div>

        <div class="form-group split-two">
          <div>
            <label for="location">Location</label>
            <input type="text" id="location" class="input-field" placeholder="Your City">
          </div>
          <div>
            <label for="gender">Gender / Identity</label>
            <select id="gender" class="input-field">
              <option value="">Select...</option>
              <option value="male">Man</option>
              <option value="female">Woman</option>
              <option value="nonbinary">Non-Binary</option>
              <option value="other">Other / Prefer not to say</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Hobbies / Interests -->
      <div class="form-section">
        <div class="form-group">
          <label for="hobbies">Hobbies (Comma Separated)</label>
          <input type="text" id="hobbies" class="input-field" placeholder="Hiking, Cooking, Gaming, Reading">
        </div>
        <div id="hobbiesDisplay" class="tags-container"></div>
      </div>

      <!-- Liked Songs -->
      <div class="form-section">
        <div class="form-group">
          <label for="likedSongs">Your 5 Favorite Songs/Artists (Comma Separated)</label>
          <textarea id="likedSongs" rows="3" class="textarea-field"></textarea>
          <p class="help-text">These are used to find your perfect match!</p>
        </div>
        <div id="songsDisplay" class="tags-container"></div>
      </div>

      <!-- Security / Password (simulated) -->
      <div class="form-section">
        <div class="form-group">
          <label for="newPassword">New Password (Simulated)</label>
          <input type="password" id="newPassword" class="input-field">
          <button type="button" onclick="changePassword(event)" class="btn btn-main w-full">Change Password</button>
          <p id="passwordMessage" class="help-text error-text"></p>
        </div>
      </div>

      <!-- Save Button -->
      <div class="form-section">
        <button id="saveButton" type="button" onclick="saveProfile()" class="btn btn-main w-full">
          ðŸ’¾ Save Profile
        </button>
      </div>

    </form>

  </div>
</div>

{{!-- JavaScript to handle profile loading and saving --}}
<script>
  // Display status messages
  function displayMessage(message, isError) {
    const statusMessage = document.getElementById('statusMessage');
    statusMessage.textContent = message;
    statusMessage.style.display = 'block';
    
    // Set colors based on error/success
    if (isError) {
      statusMessage.style.backgroundColor = '#e74c3c';
      statusMessage.style.color = '#ffffff';
    } else {
      statusMessage.style.backgroundColor = '#2ecc71';
      statusMessage.style.color = '#ffffff';
    }
    
    // Hide message after 5 seconds
    setTimeout(() => {
      statusMessage.style.display = 'none';
    }, 5000);
  }

  // Save profile function
  async function saveProfile() {
    const saveButton = document.getElementById('saveButton');
    const nameInput = document.getElementById('name');
    const usernameInput = document.getElementById('username');
    
    // Get values
    const name = nameInput.value.trim();
    const username = usernameInput.value.trim();
    
    // Validate required fields
    if (!name || !username) {
      displayMessage("Name and Username are required fields.", true);
      return;
    }
    
    // Disable button and show loading state
    saveButton.disabled = true;
    saveButton.innerHTML = 'ðŸ’¾ Saving...';
    
    try {
      // Send POST request to update profile
      const response = await fetch('/account-custom', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          name: name,
          username: username
        })
      });
      
      const result = await response.json();
      
      if (!response.ok || !result.success) {
        throw new Error(result.error || 'Failed to save profile');
      }
      
      displayMessage("Profile updated successfully!", false);
      console.log("Profile successfully saved!", result);
      
    } catch (error) {
      console.error("Error saving profile:", error);
      displayMessage("Error saving profile: " + error.message, true);
    } finally {
      // Re-enable button
      saveButton.disabled = false;
      saveButton.innerHTML = 'ðŸ’¾ Save Profile';
    }
  }
  
  // Make saveProfile available globally for onclick handler
  window.saveProfile = saveProfile;
  
  // Load user data on page load (if not already populated from server-side rendering)
  document.addEventListener('DOMContentLoaded', function() {
    // Fields should already be populated from server-side rendering
    // But if they're empty, we can fetch them here as a fallback
    const nameInput = document.getElementById('name');
    const usernameInput = document.getElementById('username');
    
    if ((!nameInput.value || !usernameInput.value) && document.getElementById('userIdDisplay').textContent !== 'Loading...') {
      // Data should be loaded, but if not, show a message
      console.log('Profile data loaded from server');
    }
  });
</script>